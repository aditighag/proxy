name: Images
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - master
      - v[0-9]+.[0-9]+
      - multi-platform-image
    tags:
      - v[0-9]+.[0-9]+.[0-9]+
      - v[0-9]+.[0-9]+.[0-9]+-rc[0-9]+

jobs:
  lint:
    if: github.repository == 'cilium/proxy'
    name: Lint image build logic
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v1
      - uses: docker://docker.io/cilium/image-maker:bc81755ec8f6c5afcb10a416cef73f99a35fee2c
        name: Run make lint
        with:
          entrypoint: make
          args: -C images lint
  build-and-push:
    if: (github.repository == 'cilium/proxy' && github.event_name != 'pull_request')
    name: Build and push all images
    runs-on: ubuntu-18.04
    needs: lint
    steps:
      - uses: actions/checkout@v1
      - uses: docker://docker.io/cilium/image-maker:bc81755ec8f6c5afcb10a416cef73f99a35fee2c
        name: Register binfmt from multi-platform builds
        with:
          entrypoint: docker
          args: run --privileged linuxkit/binfmt:5d33e7346e79f9c13a73c6952669e47a53b063d4
      - uses: docker://docker.io/cilium/image-maker:bc81755ec8f6c5afcb10a416cef73f99a35fee2c
        name: Run make lint
        with:
          entrypoint: make
          args: -C images lint
      - uses: docker://docker.io/cilium/image-maker:bc81755ec8f6c5afcb10a416cef73f99a35fee2c
        name: Run make cilium-envoy-image
        env:
          DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          QUAY_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}
          QUAY_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
        with:
          entrypoint: make
          args: -C images cilium-envoy-image PUSH=true
